import sys
sys.path.append("..")
import numpy as np
from osc import noise
from env import adsr
from biquad import biquad_filter
from window import hanning_window
from instruments.utils import calc_freq, calc_delayar


def abstract_string(note_no: int, velocity: int, gate: float, duration: float, f_lpf: float, f_hpf: float, sr: int) -> np.ndarray:
    freq: float = calc_freq(note_no)
    n_partial: int = int(np.clip(6000/freq, 5, 30))

    ratio: float = calc_delayar(offsets=note_no, p1=69, p2=0.02, p3=70/12, p4=0.18, is_sub=True)
    vib_depth: float = calc_freq(note_no + ratio) - freq
    vib: np.ndarray = vib_depth * np.sin(2 * np.pi * 8 * np.arange(int(duration*sr)) / sr)
    fluc: np.ndarray = biquad_filter(noise(sec=duration, sr=sr), filter_type="lowpass", fc=8, Q=1/np.sqrt(2), sr=sr)
    fluc = 0.5 * vib_depth / np.max(np.abs(fluc)) * fluc
    vcf: np.ndarray = (freq + vib + fluc) * np.arange(1, n_partial+1).reshape(-1, 1)

    v: np.ndarray = biquad_filter(noise(sec=duration, sr=sr), filter_type="lowpass", fc=f_lpf, Q=1/np.sqrt(2), sr=sr)
    v = biquad_filter(v, filter_type="lowpass", fc=f_lpf, Q=1/np.sqrt(2), sr=sr)
    v = biquad_filter(v, filter_type="highpass", fc=f_hpf, Q=1/np.sqrt(2), sr=sr)
    v = biquad_filter(v, filter_type="highpass", fc=f_hpf, Q=1/np.sqrt(2), sr=sr)

    y: np.ndarray = np.zeros(int(duration * sr))
    for i in range(n_partial):
        x: np.ndarray = biquad_filter(v, filter_type="bandpass", fc=vcf[i], Q=200, sr=sr)
        y += biquad_filter(x, filter_type="bandpass", fc=vcf[i], Q=200, sr=sr)
    y *= adsr(A=0.2, D=0, S=1, R=0.4, gate=gate, dur=duration, sr=sr)
    return (velocity / 127) / np.max(np.abs(y)) * y


def violin(note_no: int, velocity: int, gate: float, duration: float, sr: int =44100) -> np.ndarray:
    return abstract_string(
        note_no=note_no, velocity=velocity, gate=gate, duration=duration, f_lpf=2000, f_hpf=250, sr=sr
    )


def viola(note_no: int, velocity: int, gate: float, duration: float, sr: int =44100) -> np.ndarray:
    return abstract_string(
        note_no=note_no, velocity=velocity, gate=gate, duration=duration, f_lpf=1400, f_hpf=200, sr=sr
    )


def cello(note_no: int, velocity: int, gate: float, duration: float, sr: int =44100) -> np.ndarray:
    return abstract_string(
        note_no=note_no, velocity=velocity, gate=gate, duration=duration, f_lpf=900, f_hpf=150, sr=sr
    )


def contrabass(note_no: int, velocity: int, gate: float, duration: float, sr: int =44100) -> np.ndarray:
    return abstract_string(
        note_no=note_no, velocity=velocity, gate=gate, duration=duration, f_lpf=500, f_hpf=100, sr=sr
    )


def harp(note_no: int, velocity: int, gate: float, duration: float, sr: int =44100) -> np.ndarray:
    WIN_LEN: int = 128
    freq: float = calc_freq(note_no)

    # feedback filter
    d: float = calc_delayar(note_no, p1=70, p2=0, p3=120/12, p4=0.5, is_sub=True)
    fbk_decay: float = calc_delayar(note_no, p1=75, p2=0, p3=120/12, p4=20, is_sub=True)
    num: float = np.power(10, -3/freq/fbk_decay)
    den: float = np.sqrt((1 - d) ** 2 + 2 * d * (1 - d) * np.cos(2 * np.pi * freq / sr) + d ** 2)
    c: float = np.minimum(num/den, 1)

    # delayline
    n_delay: int = int(sr / freq - d)
    f_delay: float = sr / freq - d - n_delay
    apf_coef: float = (1 - f_delay) / (1 + f_delay)

    # Kerplus-Strong
    z: np.ndarray = np.zeros(int(duration*sr))
    n_partial: int = int(20000 / freq)
    for i in range(n_partial):
        z[:n_delay+1+WIN_LEN] += np.sin(
            2 * np.pi * freq * (i+1) * np.arange(n_delay+1+WIN_LEN) / sr + 2 * (np.random.default_rng().random() - 0.5) * np.pi
        )
    z -= np.mean(z)

    # fractional delay, feedback
    fdelays: np.ndarray = np.zeros(int(duration*sr))
    for i in range(n_delay+1+WIN_LEN, int(duration*sr)):
        fdelays[i] = - apf_coef * fdelays[i-1] + apf_coef * z[i-n_delay] + z[i-n_delay-1]
        z[i] += c * ((1 - d) * fdelays[i] + d * fdelays[i-1])

    # comb filter
    pos: float = 0.5
    u: np.ndarray = np.zeros(int(duration*sr))
    for i in range(int(duration*sr)):
        idx: float = i - pos * sr / freq
        idx_int: int = int(idx)
        idx_frac: float = idx - idx_int
        if idx_int < 0:
            u[i] = z[i] - (idx_frac * z[idx_int+1+n_delay+1] + (1 - idx_frac) * z[idx_int+n_delay+1])
        else:
            u[i] = z[i] - (idx_frac * z[idx_int+1] + (1 - idx_frac) * z[idx_int])
    z = u

    # frequency filtering
    N_FFT: int = 4096
    N_BAND: int = 64
    LOWEST_NOTE_NO: int = 23
    freqs: np.ndarray = np.array([
           0,    4,    7,   12,   16,   20,   25,   30,   35,   41,
          47,   53,   60,   67,   74,   82,   90,   99,  108,  118,
         128,  139,  150,  162,  175,  188,  202,  217,  233,  250,
         267,  286,  306,  326,  348,  371,  396,  421,  449,  477,
         508,  540,  574,  609,  647,  687,  729,  773,  820,  869,
         922,  977, 1035, 1097, 1161, 1230, 1302, 1379, 1460, 1545,
        1635, 1730, 1830, 1936, 2048
    ])
    amps: np.ndarray = np.array([
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.060858, 0.188249, 0.632011, 1.000000, 0.850353, 0.347937, 0.157694, 0.140827, 0.192228, 0.357717, 0.079275, 0.074854, 0.036400, 0.065630, 0.064848, 0.044823, 0.079304, 0.057037, 0.030086, 0.030348, 0.071365, 0.028947, 0.014450, 0.023485, 0.021666, 0.020902, 0.022189, 0.024348, 0.016225, 0.019122, 0.035220, 0.006662, 0.013261, 0.018244, 0.005799, 0.010833, 0.011369, 0.008764, 0.007319, 0.005925, 0.009274, 0.005687, 0.003852, 0.003488, 0.004024, 0.003406, 0.003140, 0.002878, 0.001997, 0.002213, 0.002079, 0.001446, 0.001384, 0.000878, 0.000447, 0.000510, 0.000274, 0.000247, 0.000164, 0.000228, 0.000244, 0.000227, 0.000281, 0.000261],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.046745, 0.094280, 0.352658, 0.938142, 1.000000, 0.490902, 0.193114, 0.153733, 0.205178, 0.168552, 0.066142, 0.033446, 0.041979, 0.041991, 0.029496, 0.050632, 0.062910, 0.018927, 0.016269, 0.020079, 0.009328, 0.015164, 0.015082, 0.020074, 0.013432, 0.007060, 0.005356, 0.004610, 0.005968, 0.009002, 0.006982, 0.008441, 0.008451, 0.006159, 0.005910, 0.004807, 0.004307, 0.004175, 0.004417, 0.002765, 0.003162, 0.002115, 0.001149, 0.001410, 0.000699, 0.001263, 0.000538, 0.001154, 0.000633, 0.000817, 0.000345, 0.000479, 0.000500, 0.000272, 0.000229, 0.000180, 0.000124, 0.000082, 0.000069, 0.000066, 0.000041, 0.000039, 0.000038, 0.000032],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [0.403562, 0.425674, 0.484043, 0.587428, 0.709932, 0.857886, 0.981276, 1.000000, 0.879080, 0.656411, 0.442764, 0.282952, 0.186616, 0.140537, 0.120961, 0.116027, 0.116218, 0.111837, 0.097189, 0.076798, 0.060819, 0.054040, 0.051387, 0.041287, 0.026989, 0.022066, 0.028222, 0.030414, 0.023646, 0.026973, 0.023235, 0.012258, 0.020054, 0.019121, 0.019388, 0.023615, 0.008311, 0.023909, 0.011396, 0.005976, 0.004115, 0.004502, 0.004226, 0.004772, 0.003377, 0.001722, 0.001412, 0.001079, 0.001299, 0.002012, 0.002120, 0.001042, 0.001323, 0.001474, 0.000733, 0.000376, 0.000353, 0.000283, 0.000262, 0.000250, 0.000183, 0.000209, 0.000165, 0.000161],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.996959, 0.989121, 0.975469, 0.958787, 0.935097, 0.903193, 0.865749, 0.818770, 0.761849, 0.700278, 0.630164, 0.553219, 0.477443, 0.400557, 0.326152, 0.258156, 0.199401, 0.151907, 0.115702, 0.090016, 0.072997, 0.062960, 0.058075, 0.057100, 0.057947, 0.057888, 0.054259, 0.046800, 0.038650, 0.032793, 0.030329, 0.030185, 0.029453, 0.026393, 0.022703, 0.020332, 0.017698, 0.013279, 0.009885, 0.009485, 0.009819, 0.008647, 0.008129, 0.007524, 0.006741, 0.008184, 0.005889, 0.004463, 0.006105, 0.005055, 0.003975, 0.005074, 0.004375, 0.004186, 0.003510, 0.002665, 0.002176, 0.001816, 0.000990, 0.000793, 0.000510, 0.000471, 0.000382],
        [1.000000, 0.995030, 0.982342, 0.960597, 0.934663, 0.899010, 0.852986, 0.801740, 0.741415, 0.673532, 0.605917, 0.535459, 0.464877, 0.401301, 0.341824, 0.288019, 0.241219, 0.201690, 0.169479, 0.143868, 0.124166, 0.109343, 0.098544, 0.090561, 0.084938, 0.080723, 0.076826, 0.072366, 0.066664, 0.059786, 0.052042, 0.044155, 0.037440, 0.032226, 0.028451, 0.025802, 0.023649, 0.021300, 0.018598, 0.016085, 0.014572, 0.014648, 0.016036, 0.017065, 0.015370, 0.011483, 0.008393, 0.007253, 0.007162, 0.006734, 0.006337, 0.007576, 0.009671, 0.008863, 0.006913, 0.006223, 0.005968, 0.008224, 0.008089, 0.003574, 0.003039, 0.001618, 0.001672, 0.001290]
    ])

    H: np.ndarray = np.zeros(N_FFT)
    for band in range(N_BAND):
        H[freqs[band]:freqs[band+1]] = amps[note_no-LOWEST_NOTE_NO][band]
    ks: np.ndarray = np.arange(1, N_FFT//2)
    H[N_FFT-ks] = H[ks]
    h: np.ndarray = np.real(np.fft.ifft(H, N_FFT))
    h = np.roll(h, -N_FFT//2)
    b: np.ndarray = hanning_window(WIN_LEN+1) * h[(N_FFT-WIN_LEN)//2:(N_FFT+WIN_LEN)//2+1]

    u = np.zeros(int(duration*sr))
    for i in range(int(duration*sr)):
        for j in range(WIN_LEN+1):
            if i - j >= 0:
                u[i] += b[j] * z[i-j]
    z = np.concatenate([u[:int(duration*sr)-WIN_LEN], np.zeros(WIN_LEN)])

    # Highpass Filter
    z = biquad_filter(z, filter_type="highpass", fc=5, Q=1/np.sqrt(2), sr=sr)
    z /= np.max(np.abs(z))

    # attack part
    vcfa: np.ndarray = 32 * freq \
                     + 512 * freq * adsr(A=0, D=5/freq, S=0, R=5/freq, gate=gate, dur=duration, sr=sr)
    vcfa = np.minimum(vcfa, 20000)
    vcaa: np.ndarray = adsr(A=4/freq, D=20/freq, S=0, R=20/freq, gate=gate, dur=duration)
    za: np.ndarray = vcaa * biquad_filter(z, filter_type="lowpass", fc=vcfa, Q=1/np.sqrt(2), sr=sr)

    # sustain part
    vcfs: np.ndarray = 8 * freq \
                     + 128 * freq * adsr(A=0, D=0.2*fbk_decay, S=0, R=0.2*fbk_decay, gate=gate, dur=duration, sr=sr)
    vcfs = np.minimum(vcfs, 20000)
    vcas: np.ndarray = adsr(A=4/freq, D=0, S=1, R=0, gate=duration, dur=duration, sr=sr)
    zs: np.ndarray = vcas * biquad_filter(z, filter_type="lowpass", fc=vcfs, Q=1/np.sqrt(2), sr=sr)

    # integrate
    vca: np.ndarray = adsr(A=0, D=0, S=1, R=0.1, gate=gate, dur=duration, sr=sr)
    z = vca * (0.5 * za + 0.5 * zs)
    return (velocity / 127) / np.max(np.abs(z)) * z